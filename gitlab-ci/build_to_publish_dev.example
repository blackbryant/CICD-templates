# 建立 -> 發佈到registry -> 發佈到dev -> 發佈到staging

stages:
  - prepare
  - testing
  - build
  - publish
  - deploy_to_dev
  - deploy_to_staging


get_version:
  stage: prepare
  script:
    - apk add --no-cache jq  
    - echo "VERSION=$(cat deno.json | jq -r '.version' | tr -d '\r')" > build.env
    - echo " $(cat deno.json | jq -r '.version')"
  artifacts:
    reports:
      dotenv: build.env  

run_tests:
    stage: testing
    image: denoland/deno:latest
    script:
      - deno test --allow-net

build_docker_image:
    stage: build
    tags:
      - shell
    needs:
      - [run_tests,get_version]
    script: 
#      - docker build -t registry.gitlab.test.com.tw:8929/fin5/shopping-cat-v2-main:1.0 .
       - echo " build version  $VERSION"
       - docker build -t $CI_REGISTRY_IMAGE:$VERSION .
publish_docker_image:
    stage: publish
    tags:
      - shell
    needs:
      - [build_docker_image,get_version]
    before_script:
#      - doecho "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin registry.gitlab.test.com.tw:8929
       - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    script:
#      - docker push registry.gitlab.test.com.tw:8929/fin5/shopping-cat-v2-main:1.0
       - echo " publish version  $VERSION"
       - docker build --network host -t $CI_REGISTRY_IMAGE:$VERSION .
       - docker push $CI_REGISTRY_IMAGE:$VERSION

deploy_to_dev:
    stage: deploy_to_dev
    tags:
      - shell
    needs:
      - [publish_docker_image,get_version]
    before_script:
      - echo " prepare to deploy to dev server"
      
      # 1. 確保 .ssh 目錄存在並設定正確權限
      - echo "Key length is ${#DEV_SERVER_PRIVATE_KEY}"
     # - mkdir -p ~/.ssh
     # - chmod 700 ~/.ssh
      
      # 2. 避免 SSH 跳出 "Are you sure you want to continue connecting?" 導致卡住
      - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
      
      # 3. 啟動 ssh-agent
      - eval $(ssh-agent -s)
      
      # 4. 需要再variable儲存DEV_SERVER_USER、DEV_SERVER_IP、DEV_SERVER_PRIVATE_KEY
      #    1) 使用 tr -d '\r' 移除可能存在的 Windows 換行符號
      #    2) 使用 ssh-add - 從標準輸入讀取
      - echo "$DEV_SERVER_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    script:
       - echo " deploy to dev version  $VERSION"
       - scp -o StrictHostKeyChecking=no ./docker-compose.yml $DEV_SERVER_USER@$DEV_SERVER_IP:~/docker-compose.yml
       - ssh -o StrictHostKeyChecking=no $DEV_SERVER_USER@$DEV_SERVER_IP "
          export COMPOSE_PROJECT_NAME=dev &&
          export APP_PORT=5000 &&
          docker compose down &&
          docker compose up -d "

    environment:
        name: dev
        url: http://$DEV_SERVER_IP:5000


deploy_to_staging:
    stage: deploy_to_staging
    tags:
      - shell
    needs:
      - [publish_docker_image,get_version]
    before_script:
      - echo " prepare to deploy to dev server"
      
      # 1. 確保 .ssh 目錄存在並設定正確權限
      - echo "Key length is ${#DEV_SERVER_PRIVATE_KEY}"
     # - mkdir -p ~/.ssh
    # - chmod 700 ~/.ssh
      
      # 2. 避免 SSH 跳出 "Are you sure you want to continue connecting?" 導致卡住
      - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
      
      # 3. 啟動 ssh-agent
      - eval $(ssh-agent -s)
      
      # 4. 需要再variable儲存DEV_SERVER_USER、DEV_SERVER_IP、DEV_SERVER_PRIVATE_KEY
      #    1) 使用 tr -d '\r' 移除可能存在的 Windows 換行符號
      #    2) 使用 ssh-add - 從標準輸入讀取
      - echo "$DEV_SERVER_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    script:
      - echo " deploy to dev version  $VERSION"
      - scp -o StrictHostKeyChecking=no ./docker-compose.yml $DEV_SERVER_USER@$DEV_SERVER_IP:~/docker-compose.yml
      - ssh -o StrictHostKeyChecking=no $DEV_SERVER_USER@$DEV_SERVER_IP "
          export COMPOSE_PROJECT_NAME=staging &&
          export APP_PORT=80 &&
          docker compose down &&
          docker compose up -d " 

    environment:
        name: staging
        url: http://$DEV_SERVER_IP:80  
